generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//ตารางข้อมูลหุ้น
model Stock {
  stock_symbol        String   @id @unique // ใช้ stock_symbol เป็น Primary Key
  name                String   @unique
  sector              String
  corporate_tax_rate  Float
  boi_support         Boolean
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  // ความสัมพันธ์
  historicalPrices    HistoricalPrice[]
  dividends           Dividend[]
  transactions        Transaction[]
  portfolio           Portfolio[]
  predictions         Prediction[]
}

//ตารางข้อมูลผู้ใช้
model User {
  user_id           String   @id @default(cuid())
  username          String   @unique
  email             String   @unique
  password          String
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  // ความสัมพันธ์
  userTaxInfo       UserTaxInfo[]
  dividendReceiveds DividendReceived[]
  transactions      Transaction[]
  portfolio         Portfolio[]
  taxCredits        TaxCredit[]
}

//ตารางประวัติราคาหุ้น (ใช้ Composite Key)
model HistoricalPrice {
  stock_symbol String
  price_date   DateTime
  open_price   Float
  high_price   Float
  low_price    Float
  close_price  Float
  price_change Float?
  percent_change Float?
  volume_shares BigInt
  volume_value BigInt

  // ความสัมพันธ์
  stock Stock @relation(fields: [stock_symbol], references: [stock_symbol])

  @@id([stock_symbol, price_date])
}

//ตารางการประกาศปันผล
model Dividend {
  dividend_id       String    @id @default(cuid())
  stock_symbol      String
  announcement_date DateTime
  ex_dividend_date  DateTime
  record_date       DateTime
  payment_date      DateTime
  dividend_per_share Float
  source_of_dividend String?
  calculation_status String @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  calculated_at      DateTime?

  // ความสัมพันธ์
  stock             Stock            @relation(fields: [stock_symbol], references: [stock_symbol])
  dividendReceiveds DividendReceived[]
}

//ตารางบันทึกการซื้อขาย (ใช้ Composite Key ตามที่คุณกำหนด)
model Transaction {
  transaction_id    String   @id @default(uuid())
  user_id           String
  stock_symbol      String
  transaction_date  DateTime
  transaction_type  String
  quantity          Int
  price_per_share   Float
  total_amount      Float
  commission        Float
  created_at        DateTime @default(now())

  // ความสัมพันธ์
  user              User     @relation(fields: [user_id], references: [user_id])
  stock             Stock    @relation(fields: [stock_symbol], references: [stock_symbol])

  @@unique([user_id, stock_symbol, created_at, transaction_type])
}

//ตารางปันผลที่ได้รับจริง
model DividendReceived {
  received_id         String   @id @default(cuid())
  user_id             String
  dividend_id         String
  shares_held         Int  //จำนวนหุ้นที่ถือไว้ในวัน record
  gross_dividend      Float //ปันผลรวก่อนหักภาษี
  withholding_tax     Float //ภาษีที่หัก 10% ไว้
  net_dividend_received Float //ปันผลสุทธิที่ได้รับ
  payment_received_date DateTime? // เพิ่มคอลัมน์นี้เพื่อความชัดเจน
  created_at          DateTime @default(now())

  // ความสัมพันธ์
  user                User     @relation(fields: [user_id], references: [user_id])
  dividend            Dividend @relation(fields: [dividend_id], references: [dividend_id])
  taxCredit           TaxCredit? // Optional one-to-one
}

//ตารางเครดิตภาษี (ใช้ received_id เป็น FK)
model TaxCredit {
  credit_id             String   @id @default(cuid())
  received_id           String   @unique // Foreign Key for one-to-one relation
  user_id               String
  tax_year              Int
  corporate_tax_rate    Float
  tax_credit_amount     Float
  taxable_income        Float
  tax_saving            Float?
  is_used               Boolean  @default(false)

  // ความสัมพันธ์
  dividendReceived    DividendReceived @relation(fields: [received_id], references: [received_id])
  user                User             @relation(fields: [user_id], references: [user_id])
}

//ตารางข้อมูลภาษีส่วนตัว (ใช้ Composite Key)
model UserTaxInfo {
  user_id               String
  tax_year              Int

  // รายได้ (Income)
  salary                Float    @default(0)
  bonus                 Float    @default(0)
  other_income          Float    @default(0)

  // 1. ค่าลดหย่อนส่วนตัวและครอบครัว
  personal_deduction    Float    @default(60000) // พื้นฐาน 60,000
  spouse_deduction      Float    @default(0)     // ลดหย่อนคู่สมรส (สูงสุด 60,000)
  child_deduction       Float    @default(0)     // ลดหย่อนบุตร
  parent_deduction      Float    @default(0)     // ลดหย่อนบิดามารดา (คนละ 30,000)
  disabled_deduction    Float    @default(0)     // ลดหย่อนผู้พิการ (คนละ 60,000)

  // --- 2. กลุ่มประกันและการออม ---
  social_security       Float    @default(0)     // ประกันสังคม (สูงสุด 9,000)
  life_insurance        Float    @default(0)     // ประกันชีวิต (สูงสุด 100,000)
  health_insurance      Float    @default(0)     // ประกันสุขภาพตัวเอง (สูงสุด 25,000)
  parent_health_insurance Float  @default(0)     // ประกันสุขภาพพ่อแม่ (สูงสุด 15,000)
  pvd_deduction         Float    @default(0)     // กองทุนสำรองเลี้ยงชีพ
  ssf_investment        Float    @default(0)     // กองทุน SSF
  rmf_investment        Float    @default(0)     // กองทุน RMF
  thaiesg_investment    Float    @default(0)     // กองทุน Thai ESG (ลดหย่อนใหม่)

  // --- 3. กลุ่มอสังหาริมทรัพย์และอื่นๆ ---
  home_loan_interest    Float    @default(0)     // ดอกเบี้ยกู้ซื้อที่อยู่อาศัย (สูงสุด 100,000)
  donation_general      Float    @default(0)     // เงินบริจาคทั่วไป
  donation_education    Float    @default(0)     // เงินบริจาคเพื่อการศึกษา/กีฬา (ลดหย่อน 2 เท่า)

  // ความสัมพันธ์
  user                  User     @relation(fields: [user_id], references: [user_id])

  @@id([user_id, tax_year])
}

//ตารางการคาดการณ์ (ใช้ Composite Key)
model Prediction {
  stock_symbol             String
  prediction_date          DateTime
  predicted_ex_dividend_date DateTime?
  predicted_record_date    DateTime?
  predicted_payment_date   DateTime?
  predicted_dividend_per_share Float?
  confidence_score         Int?
  model_version            String?
  prediction_horizon_days  Int?

  // ความสัมพันธ์
  stock                    Stock    @relation(fields: [stock_symbol], references: [stock_symbol])

  @@id([stock_symbol, prediction_date])
}

//Portfolio_Holdings View (เป็น Model ใน Prisma)
model Portfolio {
  user_id           String
  stock_symbol      String
  current_quantity  Int
  total_invested    Float
  average_cost      Float
  last_transaction_date DateTime

  // ความสัมพันธ์
  user              User     @relation(fields: [user_id], references: [user_id])
  stock             Stock    @relation(fields: [stock_symbol], references: [stock_symbol])

  @@id([user_id, stock_symbol])
}

//MarketHoliday for HistoricalPriceData to tag that day has no data
model MarketHoliday {
  holiday_date DateTime @id @db.Date
  description  String?  @default("Market Closed / No Data")
  created_at    DateTime @default(now())
}
